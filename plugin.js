function S(e){penpot.ui.sendMessage({pluginMessage:e})}function v(e){if("type"in e)return e}function q(e){switch(e.type){case"board":case"group":return e}}function A(e){switch(e.type){case"board":case"group":return e}}function Q(e){return e.type==="board"&&(!e.parent||e.parent.id===e.id)}function Z(){return{type:"icon-sets",state:{}}}function _(e){return{type:"icon-set",prefix:e,state:{},parent:Z()}}const H=new Set(["animate","animateTransform","animateMotion"]),ee=new Set(["set","discard"]);[...H,...ee];function te(e){function t(){if(e.getSharedPluginData("iconify","source")==="iconify"){const i=JSON.parse(e.getSharedPluginData("iconify","props")),r=i.name.split(":");if(r.length===2)switch(i.version){case 1:{const o=i.route||_(r[0]);return Object.assign(i,{route:o})}}}}try{return t()}catch{}}function ne(e){return{nodes:e.nodes||Object.create(null),page:e.page||null,ignoreIconNode:e.ignoreIconNode||!1,iconNodeID:e.iconNodeID||null,iconNodeData:e.iconNodeData||null}}function oe(e,t,n,i){function c(o){const a="page",s=n.nodes[a]??n.page;if(s)return o&&s.children.push(o),n.page=n.nodes[a]=s,s;const p={type:"page",id:a,name:e.name,target:"valid",children:o?[o]:[],primary:i,relative:!0};return n.nodes[p.id]=p,n.page=p,p}function r(o,a,s){if(Q(o))return c(s);const p=o.id,u=n.nodes[p];if(u)return s&&u.children.push(s),u;let f="invalid",I=!1,h,l;const d=A(o);d&&(h=te(d),h&&(l=d.height,n.iconNodeID?n.ignoreIconNode=!0:(n.iconNodeID=p,n.iconNodeData=h)));const g=q(o);if(g){const k=v(g);k?(k.blocked||(f="valid"),(!a||k.blocked)&&(n.ignoreIconNode=!0),I=k.type!=="board"):f="valid"}else n.ignoreIconNode=!0;const b={type:o.type,id:p,name:o.name,target:f,children:s?[s]:[],primary:a,relative:I,icon:h,height:l};n.nodes[p]=b;const T=o.parent;return T?r(T,a,o.id):c(o.id),b}return r(t,i)}const ie=16;function M(){return{defaultNode:"page",nodes:[{type:"page",id:"page",name:penpot.currentPage?.name??"Page"}]}}function L(){const e=penpot.currentPage,t=penpot.selection;if(!e||!t.length)return M();const n=ne({});t.forEach((l,d)=>{oe(e,l,n,!d)});const{nodes:i,page:c,iconNodeData:r,iconNodeID:o,ignoreIconNode:a}=n;if(!c)return M();const s=[];let p=c.type,u;function f(l,d=0){switch(l.target){case"ignored":{l.children.forEach(g=>{f(i[g],d)});break}case"valid":switch(l.type){case"page":{const g={type:"page",id:"page",name:l.name};s.push(g),l.children.forEach(b=>{f(i[b],d+1)});break}case"board":case"group":{const g={id:l.id,name:l.name,depth:d,type:l.type};!a&&r&&o===l.id&&(g.icon=r,g.height=l.height,u=g),l.icon||(s.push(g),l.primary&&!l.icon&&(p=l.id),l.children.forEach(b=>{f(i[b],d+1)}))}}}}f(c);let I=!1,h=ie;for(;s.length>h;)s.pop()===u&&(I=!0,h--);return I&&u&&s.push(u),{nodes:s,defaultNode:p,iconNode:u}}let $=L();function F(){return $}function re(e){$=e}let x=!1;function ce(){const e=L();JSON.stringify(e)!==JSON.stringify(F())&&(re(e),S({type:"plugin:nodes",nodes:e}))}function P(){x||(x=!0,setTimeout(()=>{x=!1,ce()},250))}function N(e,t,n=void 0){try{const i=penpot.currentFile?.getPluginData(e);if(typeof i=="string")return t?i:JSON.parse(i)}catch{}return n}function m(e,t){penpot.currentFile?.setPluginData(e,typeof t=="string"?t:JSON.stringify(t))}const j="recent";let y=[];const se=128;function ae(){const e=N(j);return e&&(y=e),e}let D=!1;function z(){D||(D=!0,setTimeout(()=>{D=!1,m(j,y),S({type:"plugin:recent-icons",icons:y})},1e3))}function V(e){for(const t of e){const n=y.indexOf(t);n!==-1&&y.splice(n,1),y.unshift(t),y.length>se&&y.pop(),z()}}function ue(){y=[],z()}function B(e,t,n,i){e.name=t,e.setSharedPluginData("iconify","source","iconify");const c={version:1,name:t,props:n,route:i};e.setSharedPluginData("iconify","props",JSON.stringify(c))}function E(e,t){const n=t/e.height,i=e.width/e.height;e.proportionLock=!1,e.resize(t*i,t),e.proportionLock=!0;function c(r){switch(r.type){case"group":case"board":r.children.forEach(c);break;default:try{const o=[...r.strokes];let a=!1;o.forEach((s,p)=>{const u=s.strokeWidth;u&&(o[p]={...s,strokeWidth:u*n},a=!0)}),a&&(r.strokes=o)}catch(o){console.log(o)}}}c(e)}function U(e,t){const n=penpot.createShapeFromSvg(e);if(!n)return null;let i=t.replace;if(i){const r=i.parent;if(!r)return n.remove(),null;const o=r.children.findIndex(p=>p.id===i.id),a=i.parentX,s=i.parentY;return n.height!==i.height&&E(n,i.height),r.insertChild(o<0?0:o,n),n.parentX=a,n.parentY=s,n.proportionLock=!0,i.remove(),n}const c=i||n;return t.parent&&t.parent.appendChild(c),c.proportionLock=!0,t.height&&c.height!==t.height&&E(c,t.height),t.x&&(c.parentX=t.x),t.y&&(c.parentY=t.y),c}function O(e,t,n,i){const c=v(e);if(!c)return t;let r=0,o=i?c.width:c.height;if(t<r)return r;const a=r+o-n;return t>a?Math.max(r,a):t}function G(e,t,n){const i=t.icons.reduce((o,a)=>o+Math.ceil(a.width),0);let c=O(e,Math.round(n.targetX-i/2),i,!0);const r=[];for(const o of t.icons){const a=O(e,Math.round(n.targetY-o.height/2),o.height,!1),s=U(o.content,{parent:v(e),x:c,y:a,height:o.height});s&&(B(s,o.name,t.props,t.route),c+=Math.ceil(o.width),r.push(s))}return V(t.icons.map(o=>o.name)),S({type:"plugin:notice",color:"success",text:`Imported ${t.icons.length>1?t.icons.length+" icons":t.icons[0].name}`}),penpot.selection=r,P(),r}function w(){S({type:"plugin:notice",color:"error",text:"Error importing icon(s) to Penpot"})}function pe(e,t){const n=penpot.currentPage,i=n?.getShapeById(e);if(!n||!i){w();return}const c=i.name;for(const r of t.icons){const o=r.name,a=U(r.content,{replace:i,x:i.parentX,y:i.parentY});if(!a){w();return}B(a,o,t.props,t.route),V([o]),S({type:"plugin:notice",color:"success",text:`Replaced ${c} with ${o}`}),penpot.selection=[a],P();return}w()}function le(e,t){const n=penpot.currentPage;if(!n){w();return}const i=e==="page"?n:n.getShapeById(e);if(!i){w();return}const c=v(i);let r,o;if(c)r=c.width/2,o=c.height/2;else{const a=penpot.viewport.center;r=a.x,o=a.y}G(i,t,{targetX:r,targetY:o})}function fe(e){const t=penpot.currentPage;if(!t){w();return}const n=e.data;n.icons[0];let i=e.drop.x,c=e.drop.y;const r=penpot.viewport,o=r.center.x,a=r.center.y,s=r.zoom,p=r.bounds.width*s,u=r.bounds.height*s,I=e.window.width-p-276*2;i-=I/2;const h=e.window.height-u;c-=h/2;const l=Math.round(o+i/s),d=Math.round(a+c/s);G(t,n,{targetX:l,targetY:d})}const X="icon-sets",Y="route-v31",K="recent-colors",R="customisations",W="pinned-filters",C="sort-icon-sets",J="group-icon-sets";function de(){console.log("Starting plugin..."),penpot.on("themechange",p=>{S({type:"plugin:theme",theme:p})});const e=N(X,!1,void 0),t=e?.version===1?e.data:void 0;let n=N(Y,!1);const i=ae(),c=N(K,!1),r=N(W,!1),o=N(C,!0,"auto"),a=N(J,!0,"auto");let s=N(R,!1);penpot.on("selectionchange",P),penpot.on("pagechange",P),penpot.ui.onMessage(p=>{try{if(typeof p?.pluginMessage!="object")return}catch(f){console.error(f)}const u=p.pluginMessage;switch(u.type){case"ui:fatal-error":{console.error("Fatal error:",u.error),penpot.closePlugin();break}case"ui:loaded":{S({type:"plugin:starting",nodes:F(),lists:t,pinned:r,recent:i,route:n,recentColors:c,custom:s,sortIconSets:o,groupIconSets:a});break}case"ui:lists":{const f={version:1,data:u.lists};m(X,f);break}case"ui:pinned-filters":{m(W,u.pinned);break}case"ui:route":{m(Y,u.route);break}case"ui:replace-icon":{pe(u.node,u.data);break}case"ui:import-icons":{le(u.node,u.data);break}case"ui:drop-icon":{fe(u);break}case"ui:recent-colors":{m(K,u.colors);break}case"ui:customisations":{m(R,u.custom);break}case"ui:reset-recent-icons":{ue();break}case"ui:sort":{m(C,u.sortIconSets),m(J,u.groupIconSets);break}}}),penpot.ui.open("Iconify",`./index.html?theme=${penpot.theme}`,{width:570,height:640})}de();
