function y(e){penpot.ui.sendMessage({pluginMessage:e})}function x(e){if("type"in e)return e}function $(e){switch(e.type){case"board":case"group":return e}}function F(e){switch(e.type){case"board":case"group":return e}}function J(e){return e.type==="board"&&(!e.parent||e.parent.id===e.id)}function V(){return{type:"icon-sets",state:{}}}function C(e){return{type:"icon-set",prefix:e,state:{},parent:V()}}const j=new Set(["animate","animateTransform","animateMotion"]),G=new Set(["set","discard"]);[...j,...G];function L(e){function t(){if(e.getSharedPluginData("iconify","source")==="iconify"){const i=JSON.parse(e.getSharedPluginData("iconify","props")),r=i.name.split(":");if(r.length===2)switch(i.version){case 1:{const o=i.route||C(r[0]);return Object.assign(i,{route:o})}}}}try{return t()}catch{}}function W(e){return{nodes:e.nodes||Object.create(null),page:e.page||null,ignoreIconNode:e.ignoreIconNode||!1,iconNodeID:e.iconNodeID||null,iconNodeData:e.iconNodeData||null}}function z(e,t,n,i){function c(o){const s="page",a=n.nodes[s]??n.page;if(a)return o&&a.children.push(o),n.page=n.nodes[s]=a,a;const u={type:"page",id:s,name:e.name,target:"valid",children:o?[o]:[],primary:i,relative:!0};return n.nodes[u.id]=u,n.page=u,u}function r(o,s,a){if(J(o))return c(a);const u=o.id,l=n.nodes[u];if(l)return a&&l.children.push(a),l;let d="invalid",S=!1,h,p;const g=F(o);g&&(h=L(g),h&&(p=g.height,n.iconNodeID?n.ignoreIconNode=!0:(n.iconNodeID=u,n.iconNodeData=h)));const f=$(o);if(f){const w=x(f);w?(w.blocked||(d="valid"),(!s||w.blocked)&&(n.ignoreIconNode=!0),S=w.type!=="board"):d="valid"}else n.ignoreIconNode=!0;const m={type:o.type,id:u,name:o.name,target:d,children:a?[a]:[],primary:s,relative:S,icon:h,height:p};n.nodes[u]=m;const D=o.parent;return D?r(D,s,o.id):c(o.id),m}return r(t,i)}const B=16;function T(){const e=penpot.currentPage;return{defaultNode:"page",nodes:[{type:"page",id:"page",name:(e==null?void 0:e.name)??"Page"}]}}function k(){const e=penpot.currentPage,t=penpot.selection;if(!e||!t.length)return T();const n=W({});t.forEach((p,g)=>{z(e,p,n,!g)});const{nodes:i,page:c,iconNodeData:r,iconNodeID:o,ignoreIconNode:s}=n;if(!c)return T();const a=[];let u=c.type,l;function d(p,g=0){switch(p.target){case"ignored":{p.children.forEach(f=>{d(i[f],g)});break}case"valid":switch(p.type){case"page":{const f={type:"page",id:"page",name:p.name};a.push(f),p.children.forEach(m=>{d(i[m],g+1)});break}case"board":case"group":{const f={id:p.id,name:p.name,depth:g,type:p.type};!s&&r&&o===p.id&&(f.icon=r,f.height=p.height,l=f),p.icon||(a.push(f),p.primary&&!p.icon&&(u=p.id),p.children.forEach(m=>{d(i[m],g+1)}))}}}}d(c);let S=!1,h=B;for(;a.length>h;)a.pop()===l&&(S=!0,h--);return S&&l&&a.push(l),{nodes:a,defaultNode:u,iconNode:l}}let O=k();function E(){return O}function U(e){O=e}let b=!1;function K(){const e=k();JSON.stringify(e)!==JSON.stringify(E())&&(U(e),y({type:"plugin:nodes",nodes:e}))}function P(){b||(b=!0,setTimeout(()=>{b=!1,K()},250))}function q(e,t){var n;(n=penpot.currentFile)==null||n.setPluginData(e,typeof t=="string"?t:JSON.stringify(t))}const A="recent";let N=[];const H=128;let v=!1;function Q(){v||(v=!0,setTimeout(()=>{v=!1,q(A,N),y({type:"plugin:recent-icons",icons:N})},1e3))}function R(e){for(const t of e){const n=N.indexOf(t);n!==-1&&N.splice(n,1),N.unshift(t),N.length>H&&N.pop(),Q()}}function X(e,t,n,i){e.name=t,e.setSharedPluginData("iconify","source","iconify");const c={version:1,name:t,props:n,route:i};e.setSharedPluginData("iconify","props",JSON.stringify(c))}function Y(e,t){const n=penpot.createShapeFromSvg(e);if(!n)return null;console.log("createNodeFromSVG: frame size:",n.width,n.height);let i=t.replace;if(i){const r=i.parent;if(!r)return n.remove(),null;const o=r.children.findIndex(l=>l.id===i.id),s=i.parentX,a=i.parentY,u=n.width/n.height;return console.log("createNodeFromSVG: ratio:",u),n.resize(i.height*u,i.height),r.insertChild(o<0?0:o,n),n.parentX=s,n.parentY=a,n.proportionLock=!0,i.remove(),n}const c=i||n;return t.parent&&t.parent.appendChild(c),t.x&&(c.parentX=t.x),t.y&&(c.parentY=t.y),c.proportionLock=!0,c}function M(e,t,n,i){const c=x(e);if(!c)return t;let r=0,o=i?c.width:c.height;if(t<r)return r;const s=r+o-n;return t>s?Math.max(r,s):t}function Z(e,t,n){const i=t.icons.reduce((o,s)=>o+Math.ceil(s.width),0);let c=M(e,Math.round(n.targetX-i/2),i,!0);const r=[];for(const o of t.icons){const s=M(e,Math.round(n.targetY-o.height/2),o.height,!1),a=Y(o.content,{parent:x(e),x:c,y:s});a&&(X(a,o.name,t.props,t.route),c+=Math.ceil(o.width),r.push(a))}return R(t.icons.map(o=>o.name)),y({type:"plugin:notice",color:"success",text:`Imported ${t.icons.length>1?t.icons.length+" icons":t.icons[0].name}`}),penpot.selection=r,P(),r}function I(){y({type:"plugin:notice",color:"error",text:"Error importing icon(s) to Penpot"})}function _(e,t){const n=penpot.currentPage,i=n==null?void 0:n.getShapeById(e);if(!n||!i){I();return}const c=i.name;for(const r of t.icons){const o=r.name,s=Y(r.content,{replace:i,x:i.parentX,y:i.parentY});if(!s){I();return}X(s,o,t.props,t.route),R([o]),y({type:"plugin:notice",color:"success",text:`Replaced ${c} with ${o}`}),penpot.selection=[s],P();return}I()}function ee(e,t){const n=penpot.currentPage;if(!n){I();return}const i=e==="page"?n:n.getShapeById(e);if(!i){I();return}const c=x(i);let r,o;if(c)r=c.width/2,o=c.height/2;else{const s=penpot.viewport.center;r=s.x,o=s.y}Z(i,t,{targetX:r,targetY:o})}function ne(){console.log("Starting plugin..."),penpot.on("themechange",e=>{y({type:"plugin:theme",theme:e})}),penpot.on("selectionchange",P),penpot.on("pagechange",P),penpot.ui.onMessage(e=>{try{if(typeof(e==null?void 0:e.pluginMessage)!="object")return}catch(n){console.error(n)}const t=e.pluginMessage;switch(t.type){case"ui:loaded":{y({type:"plugin:starting",nodes:E()});break}case"ui:replace-icon":{_(t.node,t.data);break}case"ui:import-icons":{ee(t.node,t.data);break}}}),penpot.ui.open("Iconify",`./index.html?theme=${penpot.theme}`,{width:570,height:640})}ne();
