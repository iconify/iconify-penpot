function m(e){penpot.ui.sendMessage({pluginMessage:e})}function v(e){if("type"in e)return e}function U(e){switch(e.type){case"board":case"group":return e}}function G(e){switch(e.type){case"board":case"group":return e}}function q(e){return e.type==="board"&&(!e.parent||e.parent.id===e.id)}function A(){return{type:"icon-sets",state:{}}}function Q(e){return{type:"icon-set",prefix:e,state:{},parent:A()}}const Z=new Set(["animate","animateTransform","animateMotion"]),_=new Set(["set","discard"]);[...Z,..._];function H(e){function n(){if(e.getSharedPluginData("iconify","source")==="iconify"){const i=JSON.parse(e.getSharedPluginData("iconify","props")),s=i.name.split(":");if(s.length===2)switch(i.version){case 1:{const o=i.route||Q(s[0]);return Object.assign(i,{route:o})}}}}try{return n()}catch{}}function ee(e){return{nodes:e.nodes||Object.create(null),page:e.page||null,ignoreIconNode:e.ignoreIconNode||!1,iconNodeID:e.iconNodeID||null,iconNodeData:e.iconNodeData||null}}function te(e,n,t,i){function c(o){const a="page",r=t.nodes[a]??t.page;if(r)return o&&r.children.push(o),t.page=t.nodes[a]=r,r;const p={type:"page",id:a,name:e.name,target:"valid",children:o?[o]:[],primary:i,relative:!0};return t.nodes[p.id]=p,t.page=p,p}function s(o,a,r){if(q(o))return c(r);const p=o.id,l=t.nodes[p];if(l)return r&&l.children.push(r),l;let g="invalid",N=!1,h,u;const f=G(o);f&&(h=H(f),h&&(u=f.height,t.iconNodeID?t.ignoreIconNode=!0:(t.iconNodeID=p,t.iconNodeData=h)));const d=U(o);if(d){const k=v(d);k?(k.blocked||(g="valid"),(!a||k.blocked)&&(t.ignoreIconNode=!0),N=k.type!=="board"):g="valid"}else t.ignoreIconNode=!0;const b={type:o.type,id:p,name:o.name,target:g,children:r?[r]:[],primary:a,relative:N,icon:h,height:u};t.nodes[p]=b;const T=o.parent;return T?s(T,a,o.id):c(o.id),b}return s(n,i)}const ne=16;function M(){const e=penpot.currentPage;return{defaultNode:"page",nodes:[{type:"page",id:"page",name:(e==null?void 0:e.name)??"Page"}]}}function J(){const e=penpot.currentPage,n=penpot.selection;if(!e||!n.length)return M();const t=ee({});n.forEach((u,f)=>{te(e,u,t,!f)});const{nodes:i,page:c,iconNodeData:s,iconNodeID:o,ignoreIconNode:a}=t;if(!c)return M();const r=[];let p=c.type,l;function g(u,f=0){switch(u.target){case"ignored":{u.children.forEach(d=>{g(i[d],f)});break}case"valid":switch(u.type){case"page":{const d={type:"page",id:"page",name:u.name};r.push(d),u.children.forEach(b=>{g(i[b],f+1)});break}case"board":case"group":{const d={id:u.id,name:u.name,depth:f,type:u.type};!a&&s&&o===u.id&&(d.icon=s,d.height=u.height,l=d),u.icon||(r.push(d),u.primary&&!u.icon&&(p=u.id),u.children.forEach(b=>{g(i[b],f+1)}))}}}}g(c);let N=!1,h=ne;for(;r.length>h;)r.pop()===l&&(N=!0,h--);return N&&l&&r.push(l),{nodes:r,defaultNode:p,iconNode:l}}let K=J();function $(){return K}function oe(e){K=e}let x=!1;function ie(){const e=J();JSON.stringify(e)!==JSON.stringify($())&&(oe(e),m({type:"plugin:nodes",nodes:e}))}function P(){x||(x=!0,setTimeout(()=>{x=!1,ie()},250))}function w(e,n,t=void 0){var i;try{const c=(i=penpot.currentFile)==null?void 0:i.getPluginData(e);if(typeof c=="string")return n?c:JSON.parse(c)}catch{}return t}function I(e,n){var t;(t=penpot.currentFile)==null||t.setPluginData(e,typeof n=="string"?n:JSON.stringify(n))}const F="recent";let y=[];const re=128;function ce(){const e=w(F);return e&&(y=e),e}let D=!1;function L(){D||(D=!0,setTimeout(()=>{D=!1,I(F,y),m({type:"plugin:recent-icons",icons:y})},1e3))}function j(e){for(const n of e){const t=y.indexOf(n);t!==-1&&y.splice(t,1),y.unshift(n),y.length>re&&y.pop(),L()}}function se(){y=[],L()}function z(e,n,t,i){e.name=n,e.setSharedPluginData("iconify","source","iconify");const c={version:1,name:n,props:t,route:i};e.setSharedPluginData("iconify","props",JSON.stringify(c))}function E(e,n){const t=n/e.height,i=e.width/e.height;e.proportionLock=!1,e.resize(n*i,n),e.proportionLock=!0;function c(s){switch(s.type){case"group":case"board":s.children.forEach(c);break;default:try{const o=[...s.strokes];let a=!1;o.forEach((r,p)=>{const l=r.strokeWidth;l&&(o[p]={...r,strokeWidth:l*t},a=!0)}),a&&(s.strokes=o)}catch(o){console.log(o)}}}c(e)}function V(e,n){const t=penpot.createShapeFromSvg(e);if(!t)return null;let i=n.replace;if(i){const s=i.parent;if(!s)return t.remove(),null;const o=s.children.findIndex(p=>p.id===i.id),a=i.parentX,r=i.parentY;return t.height!==i.height&&E(t,i.height),s.insertChild(o<0?0:o,t),t.parentX=a,t.parentY=r,t.proportionLock=!0,i.remove(),t}const c=i||t;return n.parent&&n.parent.appendChild(c),c.proportionLock=!0,n.height&&c.height!==n.height&&E(c,n.height),n.x&&(c.parentX=n.x),n.y&&(c.parentY=n.y),c}function O(e,n,t,i){const c=v(e);if(!c)return n;let s=0,o=i?c.width:c.height;if(n<s)return s;const a=s+o-t;return n>a?Math.max(s,a):n}function B(e,n,t){const i=n.icons.reduce((o,a)=>o+Math.ceil(a.width),0);let c=O(e,Math.round(t.targetX-i/2),i,!0);const s=[];for(const o of n.icons){const a=O(e,Math.round(t.targetY-o.height/2),o.height,!1),r=V(o.content,{parent:v(e),x:c,y:a,height:o.height});r&&(z(r,o.name,n.props,n.route),c+=Math.ceil(o.width),s.push(r))}return j(n.icons.map(o=>o.name)),m({type:"plugin:notice",color:"success",text:`Imported ${n.icons.length>1?n.icons.length+" icons":n.icons[0].name}`}),penpot.selection=s,P(),s}function S(){m({type:"plugin:notice",color:"error",text:"Error importing icon(s) to Penpot"})}function ae(e,n){const t=penpot.currentPage,i=t==null?void 0:t.getShapeById(e);if(!t||!i){S();return}const c=i.name;for(const s of n.icons){const o=s.name,a=V(s.content,{replace:i,x:i.parentX,y:i.parentY});if(!a){S();return}z(a,o,n.props,n.route),j([o]),m({type:"plugin:notice",color:"success",text:`Replaced ${c} with ${o}`}),penpot.selection=[a],P();return}S()}function ue(e,n){const t=penpot.currentPage;if(!t){S();return}const i=e==="page"?t:t.getShapeById(e);if(!i){S();return}const c=v(i);let s,o;if(c)s=c.width/2,o=c.height/2;else{const a=penpot.viewport.center;s=a.x,o=a.y}B(i,n,{targetX:s,targetY:o})}function pe(e){const n=penpot.currentPage;if(!n){S();return}const t=e.data;t.icons[0];let i=e.drop.x,c=e.drop.y;const s=penpot.viewport,o=s.center.x,a=s.center.y,r=s.zoom,p=s.bounds.width*r,l=s.bounds.height*r,N=e.window.width-p-276*2;i-=N/2;const h=e.window.height-l;c-=h/2;const u=Math.round(o+i/r),f=Math.round(a+c/r);B(n,t,{targetX:u,targetY:f})}const X="icon-sets",Y="route-v31",R="recent-colors",W="customisations",C="pinned-filters";function le(){console.log("Starting plugin..."),penpot.on("themechange",a=>{m({type:"plugin:theme",theme:a})});const e=w(X,!1,void 0),n=(e==null?void 0:e.version)===1?e.data:void 0;let t=w(Y,!1);const i=ce(),c=w(R,!1),s=w(C,!1);let o=w(W,!1);penpot.on("selectionchange",P),penpot.on("pagechange",P),penpot.ui.onMessage(a=>{try{if(typeof(a==null?void 0:a.pluginMessage)!="object")return}catch(p){console.error(p)}const r=a.pluginMessage;switch(r.type){case"ui:fatal-error":{console.error("Fatal error:",r.error),penpot.closePlugin();break}case"ui:loaded":{m({type:"plugin:starting",nodes:$(),lists:n,pinned:s,recent:i,route:t,recentColors:c,custom:o});break}case"ui:lists":{const p={version:1,data:r.lists};I(X,p);break}case"ui:pinned-filters":{I(C,r.pinned);break}case"ui:route":{I(Y,r.route);break}case"ui:replace-icon":{ae(r.node,r.data);break}case"ui:import-icons":{ue(r.node,r.data);break}case"ui:drop-icon":{pe(r);break}case"ui:recent-colors":{I(R,r.colors);break}case"ui:customisations":{I(W,r.custom);break}case"ui:reset-recent-icons":{se();break}}}),penpot.ui.open("Iconify",`./index.html?theme=${penpot.theme}`,{width:570,height:640})}le();
